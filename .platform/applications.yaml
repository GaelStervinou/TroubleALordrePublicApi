front:
  type: 'nodejs:20'
  source:
    root: front

  build:
    flavor: none

  hooks:
    build: |
      set -e
      npm install
    deploy: |
      npm run build

      
  web:
    locations:
      "/":
        root: "dist"
        passthru: "/index.html"
        index:
          - "index.html"
        expires: 300s
        scripts: true
        allow: true
        rules:
          \.(css|js|gif|jpe?g|png|ttf|eot|woff2?|otf|html|ico|svg?)$:
            allow: true
          ^/admin/robots\.txt$:
            allow: true
          ^/admin/manifest\.json$:
            allow: true
          ^/admin/_next:
            allow: true
          ^/admin/sitemap:
            allow: true
        headers:
          Access-Control-Allow-Origin: "*"

  disk: 1024

api:
  type: php:8.3
  source:
    root: api
  dependencies:
    php:
      composer/composer: "^2"

  runtime:
    extensions:
      - apcu
      - ctype
      - iconv
      - mbstring
      - pdo_pgsql
      - sodium
      - xsl


  variables:
    php:
      opcache.preload: config/preload.php
  build:
    flavor: none

  disk: 1024

  web:
    locations:
      "/":
        root: "public"
        passthru: '/index.php'
        index:
          - index.php
        scripts: true
        allow: true
        headers:
          Access-Control-Allow-Origin: "*"

  mounts:
    "/var": { source: local, source_path: var }

  relationships:
    database: "database:postgresql"

  hooks:
    build: |
      cp .env.example .env
      set -x -e
      curl -s https://get.symfony.com/cloud/configurator | bash
      symfony-build
      bin/console lexik:jwt:generate-keypair --overwrite
    deploy: |
      set -x -e
      symfony-deploy
